<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="shared-styles.html">

<dom-module id="rt-define">
  <template>
    <style include="shared-styles iron-flex-factors iron-flex-alignment iron-positioning ">
      :host {
        display: block;
        @apply(--layout-vertical);
        padding: 25px;
      }
    </style>

    <h2>{{title}}</h2>
    <paper-input placeholder='text input' value='{{relationFromString}}'></paper-input>
    <paper-button id='fileInput' on-click='_onFileClick'>Load File</paper-button>

  </template>

  <script>
    Polymer({
      is: 'rt-define',
      ready: function(){
        this.input = this.create('input',{
          type: 'file',
          accept: '.txt'
        });
        this.input.onchange = this._loadFile.bind(this);
      },
      observers: [
        '_computeResults(relationFromFile)',
        '_computeResults(relationFromString)'
      ],
      properties: {
        title: {notify: true, value: 'Relationship Definition'},
        relationFromFile: {notify: true},
        file: {notify: true},
        relationFromString: {notify: true},
        edges: {notify: true},
        nodes: {notify: true},
        numNodes: {notify: true, computed: '_numNodes(nodes)'},
        nodeList: {notify: true},
        results: {notify: true, computed: '_results(nodes,edges,numNodes,nodeList)'},

      },
      _results: function(nodes,edges, numNodes, nodeList){
        var results = {
          graphData: {nodes: nodes, edges: edges},
          numNodes: numNodes,
          nodeList: nodeList
        };
        console.log(results);
        return results;
      },
      _numNodes: function(nodes){
        return nodes.length;
      },
      _computeResults: function(relationships){
        var nodes = [];
        var edges = [];
        var nodeList = [];
        var edgeList = [];
        console.log('relationships: ',relationships.replace(/\r/g, "").replace(/\n/g, ""))
        //sanitized and structure relationship string for edge and node parsing
        relationships.replace(/\r/g, "").replace(/\n/g, "").split(';').forEach(function(el){
          var sanitized = el.split(' ').filter(function(el){
            return el != '' && nodeList.indexOf(el) == -1;
          },this);
          console.log('sanitized:',sanitized)
          var structured = {
            data:{
              id: sanitized[0]+sanitized[1],
              source: sanitized[0],
              target: sanitized[1]
            }
          };
          console.log('structured:',structured)
          nodes = nodes.concat(sanitized);
          edges= edges.concat(structured);
        },this);
        console.log('nodes: ',nodes)
        console.log('edges: ',edges)

        //create nodelist array
        nodes.forEach(function(el){
          if(nodeList.indexOf(el) == -1){
            nodeList.push(el)
          }
        },this);
        this.nodeList = nodeList;
        console.log('nodeList: ',this.nodeList);

        this.nodes =  nodeList.map(function(el){
          return {data:{id:el}};
        },this);
        console.log('formal nodes:',this.nodes)


        edges = relationships.toString().split('\n').map(function(el){
          var sanitized = el.replace(';','').replace('\r','').split(' ');
          var structured = {
            data:{
              id: sanitized[0]+sanitized[1],
              source: sanitized[0],
              target: sanitized[1]
            }
          };
          return structured;
        },this);
        this.edges = edges;
        console.log('formal edges:',this.edges)
      },
      _onFileClick: function(e){
        this.input.click();
      },
      _loadFile: function(e){
        this.reader = new FileReader();
        this.reader.onload = this._onFileLoad.bind(this);
        this.reader.readAsText(this.input.files[0]);
      },
      _onFileLoad: function(e){
        this.relationFromFile = this.reader.result;
        console.log(this.relationFromFile);
      }
    });
  </script>
</dom-module>
